ВЫБРАТЬ
	ЗаказПокупателя.Ссылка
ПОМЕСТИТЬ ЗаказыДляАнализа
ИЗ
	Документ.ЗаказПокупателя КАК ЗаказПокупателя
ГДЕ
	НЕ ЗаказПокупателя.ПометкаУдаления
	И ЗаказПокупателя.Дата МЕЖДУ &НачПериода И &КонПериода
	И ЗаказПокупателя.ЗаказЧерезИнтернетМагазин
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ЗаказыДляАнализа.Ссылка,
	ЗаказПокупателяТовары.Номенклатура.ВидНоменклатуры,
	СУММА(ЗаказПокупателяТовары.Количество) КАК Количество,
	СУММА(ЗаказПокупателяТовары.Сумма) КАК Сумма
ПОМЕСТИТЬ ТоварыИУслуги
ИЗ
	ЗаказыДляАнализа КАК ЗаказыДляАнализа
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
		ПО ЗаказыДляАнализа.Ссылка = ЗаказПокупателяТовары.Ссылка
ГДЕ
	НЕ ЗаказПокупателяТовары.Номенклатура.ВидНоменклатуры ЕСТЬ NULL 
	И НЕ ЗаказПокупателяТовары.Номенклатура В ИЕРАРХИИ (&КоммерческиеУслуги)

СГРУППИРОВАТЬ ПО
	ЗаказыДляАнализа.Ссылка,
	ЗаказПокупателяТовары.Номенклатура.ВидНоменклатуры

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ЗаказыДляАнализа.Ссылка,
	ЗаказПокупателяУслуги.Номенклатура.ВидНоменклатуры,
	СУММА(ЗаказПокупателяУслуги.Количество),
	СУММА(ЗаказПокупателяУслуги.Сумма)
ИЗ
	ЗаказыДляАнализа КАК ЗаказыДляАнализа
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Услуги КАК ЗаказПокупателяУслуги
		ПО ЗаказыДляАнализа.Ссылка = ЗаказПокупателяУслуги.Ссылка
ГДЕ
	НЕ ЗаказПокупателяУслуги.Номенклатура.ВидНоменклатуры ЕСТЬ NULL 
	И НЕ ЗаказПокупателяУслуги.Номенклатура В ИЕРАРХИИ (&КоммерческиеУслуги)

СГРУППИРОВАТЬ ПО
	ЗаказыДляАнализа.Ссылка,
	ЗаказПокупателяУслуги.Номенклатура.ВидНоменклатуры
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ТоварыИУслуги.Ссылка,
	СУММА(ТоварыИУслуги.Количество) КАК Количество,
	СУММА(ТоварыИУслуги.Сумма) КАК Сумма,
	СУММА(ЕСТЬNULL(ВЫБОР
				КОГДА ТоварыИУслуги.НоменклатураВидНоменклатуры.Код = "ЦОФ000003"
					ТОГДА 0
				КОГДА ТоварыИУслуги.НоменклатураВидНоменклатуры.Код <> "000000001"
					ТОГДА ТоварыИУслуги.Сумма
			КОНЕЦ, 0)) КАК СуммаПрикрепления
ПОМЕСТИТЬ РасчетСуммыПрикрепления
ИЗ
	ТоварыИУслуги КАК ТоварыИУслуги

СГРУППИРОВАТЬ ПО
	ТоварыИУслуги.Ссылка
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ РАЗЛИЧНЫЕ
	ЗаказыДляАнализа.Ссылка КАК Ссылка
ПОМЕСТИТЬ ВТЗаказыСНаличиемОсновногоТовара
ИЗ
	ЗаказыДляАнализа КАК ЗаказыДляАнализа
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
		ПО ЗаказыДляАнализа.Ссылка = ЗаказПокупателяТовары.Ссылка
ГДЕ
	НЕ ЗаказПокупателяТовары.Номенклатура.ВидНоменклатуры ЕСТЬ NULL 
	И НЕ ЗаказПокупателяТовары.Номенклатура В ИЕРАРХИИ (&КоммерческиеУслуги)
	И ЗаказПокупателяТовары.Номенклатура.ВидНоменклатуры.Код = "000000001"

СГРУППИРОВАТЬ ПО
	ЗаказыДляАнализа.Ссылка

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ЗаказыДляАнализа.Ссылка
ИЗ
	ЗаказыДляАнализа КАК ЗаказыДляАнализа
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Услуги КАК ЗаказПокупателяУслуги
		ПО ЗаказыДляАнализа.Ссылка = ЗаказПокупателяУслуги.Ссылка
ГДЕ
	НЕ ЗаказПокупателяУслуги.Номенклатура.ВидНоменклатуры ЕСТЬ NULL 
	И НЕ ЗаказПокупателяУслуги.Номенклатура В ИЕРАРХИИ (&КоммерческиеУслуги)
	И ЗаказПокупателяУслуги.Номенклатура.ВидНоменклатуры.Код = "000000001"

СГРУППИРОВАТЬ ПО
	ЗаказыДляАнализа.Ссылка
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	РасчетСуммыПрикрепления.Ссылка КАК ЗаказПокупателя,
	РасчетСуммыПрикрепления.Количество КАК КоличествоТоваров,
	ВЫБОР
		КОГДА ВТЗаказыСНаличиемОсновногоТовара.Ссылка ЕСТЬ NULL 
			ТОГДА 0
		ИНАЧЕ РасчетСуммыПрикрепления.СуммаПрикрепления
	КОНЕЦ КАК СуммаПрикрепления,
	ВЫБОР
		КОГДА РасчетСуммыПрикрепления.Сумма = 0
				ИЛИ НЕ ВЫБОР
						КОГДА ВТЗаказыСНаличиемОсновногоТовара.Ссылка ЕСТЬ NULL 
							ТОГДА ЛОЖЬ
						ИНАЧЕ ИСТИНА
					КОНЕЦ
			ТОГДА 0
		ИНАЧЕ ВЫРАЗИТЬ(ЕСТЬNULL(РасчетСуммыПрикрепления.СуммаПрикрепления, 0) * 100 / РасчетСуммыПрикрепления.Сумма КАК ЧИСЛО(10, 2))
	КОНЕЦ КАК ПроцентПрикрепления,
	РасчетСуммыПрикрепления.Ссылка.Ответственный КАК Ответственный,
	РасчетСуммыПрикрепления.Ссылка.Продавец КАК Продавец,
	РасчетСуммыПрикрепления.Ссылка.ВидОплаты КАК ВидОплаты,
	СтатусыЗаказовИМСрезПоследних.ИнформационныйСтатус,
	СтатусыЗаказовИМСрезПоследних.Статус,
	РасчетСуммыПрикрепления.Ссылка.ИсточникЗаказаИМ КАК ИсточникЗаказа,
	СнимкиЗаказовПокупателей.КоличествоТоваров КАК КоличествоТоваровИсходныйЗаказ,
	ЕСТЬNULL(СнимкиЗаказовПокупателей.СуммаПрикрепления, 0) КАК СуммаПрикрепленияИсходныйЗаказ,
	ЕСТЬNULL(СнимкиЗаказовПокупателей.ПроцентПрикрепления, 0) КАК ПроцентПрикрепленияИсходныйЗаказ,
	ВЫБОР
		КОГДА ВТЗаказыСНаличиемОсновногоТовара.Ссылка ЕСТЬ NULL 
			ТОГДА ЛОЖЬ
		ИНАЧЕ ИСТИНА
	КОНЕЦ КАК ЕстьОсновнойТовар,
	ЕСТЬNULL(СнимкиЗаказовПокупателейОбработанныйЗаказ.КоличествоТоваров, 0) КАК КоличествоТоваровОбработанныйЗаказ,
	ЕСТЬNULL(СнимкиЗаказовПокупателейОбработанныйЗаказ.СуммаПрикрепления, 0) КАК СуммаПрикрепленияОбработанныйЗаказ,
	ЕСТЬNULL(СнимкиЗаказовПокупателейОбработанныйЗаказ.ПроцентПрикрепления, 0) КАК ПроцентПрикрепленияОбработанныйЗаказ
ПОМЕСТИТЬ ДоДобавленияПроцентовПрикрепления
ИЗ
	РасчетСуммыПрикрепления КАК РасчетСуммыПрикрепления
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтатусыЗаказовИМ.СрезПоследних(&КонПериодаСтатусыЗП, ) КАК СтатусыЗаказовИМСрезПоследних
		ПО РасчетСуммыПрикрепления.Ссылка = СтатусыЗаказовИМСрезПоследних.Заказ
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СнимкиЗаказовПокупателей КАК СнимкиЗаказовПокупателей
		ПО РасчетСуммыПрикрепления.Ссылка = СнимкиЗаказовПокупателей.ЗаказПокупателя
			И (СнимкиЗаказовПокупателей.Снимок = ЗНАЧЕНИЕ(Справочник.СнимкиЗаказовПокупателей.ИсходныйЗаказ))
		ЛЕВОЕ СОЕДИНЕНИЕ ВТЗаказыСНаличиемОсновногоТовара КАК ВТЗаказыСНаличиемОсновногоТовара
		ПО РасчетСуммыПрикрепления.Ссылка = ВТЗаказыСНаличиемОсновногоТовара.Ссылка
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СнимкиЗаказовПокупателей КАК СнимкиЗаказовПокупателейОбработанныйЗаказ
		ПО РасчетСуммыПрикрепления.Ссылка = СнимкиЗаказовПокупателейОбработанныйЗаказ.ЗаказПокупателя
			И (СнимкиЗаказовПокупателейОбработанныйЗаказ.Снимок = ЗНАЧЕНИЕ(Справочник.СнимкиЗаказовПокупателей.ОбработанныйЗаказ))
ГДЕ
	СтатусыЗаказовИМСрезПоследних.Период МЕЖДУ &НачПериодаСтатусыЗП И &КонПериодаСтатусыЗП
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ДоДобавленияПроцентовПрикрепления.ЗаказПокупателя,
	ДоДобавленияПроцентовПрикрепления.КоличествоТоваров,
	ДоДобавленияПроцентовПрикрепления.СуммаПрикрепления,
	ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления,
	ДоДобавленияПроцентовПрикрепления.Ответственный,
	ДоДобавленияПроцентовПрикрепления.Продавец,
	ДоДобавленияПроцентовПрикрепления.ВидОплаты,
	ДоДобавленияПроцентовПрикрепления.ИнформационныйСтатус,
	ДоДобавленияПроцентовПрикрепления.Статус,
	ДоДобавленияПроцентовПрикрепления.ИсточникЗаказа,
	ДоДобавленияПроцентовПрикрепления.КоличествоТоваровИсходныйЗаказ,
	ДоДобавленияПроцентовПрикрепления.СуммаПрикрепленияИсходныйЗаказ,
	ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ,
	ВЫБОР
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ < 0.12
			ТОГДА 1
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ <= 9.99
			ТОГДА 1.2
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ <= 14.99
			ТОГДА 1.5
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ <= 19.99
			ТОГДА 1.8
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ <= 49.99
			ТОГДА 2
		ИНАЧЕ 2.5
	КОНЕЦ КАК КоэффициентИсходныйЗаказ,
	ВЫБОР
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления < 0.12
			ТОГДА 1
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления <= 9.99
			ТОГДА 1.2
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления <= 14.99
			ТОГДА 1.5
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления <= 19.99
			ТОГДА 1.8
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления <= 49.99
			ТОГДА 2
		ИНАЧЕ 2.5
	КОНЕЦ КАК Коэффициент,
	ДоДобавленияПроцентовПрикрепления.ЕстьОсновнойТовар,
	ДоДобавленияПроцентовПрикрепления.КоличествоТоваровОбработанныйЗаказ,
	ДоДобавленияПроцентовПрикрепления.СуммаПрикрепленияОбработанныйЗаказ,
	ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ,
	ВЫБОР
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ < 0.12
			ТОГДА 1
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ <= 9.99
			ТОГДА 1.2
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ <= 14.99
			ТОГДА 1.5
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ <= 19.99
			ТОГДА 1.8
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ <= 49.99
			ТОГДА 2
		ИНАЧЕ 2.5
	КОНЕЦ КАК КоэффициентОбработанныйЗаказ,
	ВЫБОР
		КОГДА ЕСТЬNULL(ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления, 0) > 0
			ТОГДА 1
		ИНАЧЕ 0
	КОНЕЦ КАК ПроцентПрикрепленияКоличество,
	ВЫБОР
		КОГДА ЕСТЬNULL(ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ, 0) > 0
			ТОГДА 1
		ИНАЧЕ 0
	КОНЕЦ КАК ПроцентПрикрепленияИсходныйЗаказКоличество,
	ВЫБОР
		КОГДА ЕСТЬNULL(ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ, 0) > 0
			ТОГДА 1
		ИНАЧЕ 0
	КОНЕЦ КАК ПроцентПрикрепленияОбработанныйЗаказКоличество,
	ВЫБОР
		КОГДА ДоДобавленияПроцентовПрикрепления.ЕстьОсновнойТовар
			ТОГДА 1
		ИНАЧЕ 0
	КОНЕЦ КАК КоличествоВыполненныхЗаказов,
	ВЫБОР
		КОГДА ДоДобавленияПроцентовПрикрепления.СуммаПрикрепления > 0
			ТОГДА 1
		ИНАЧЕ 0
	КОНЕЦ КАК КоличествоКомплексныхЗаказов
ПОМЕСТИТЬ ПочтиГотовыйЗапрос
ИЗ
	ДоДобавленияПроцентовПрикрепления КАК ДоДобавленияПроцентовПрикрепления
ГДЕ
	ДоДобавленияПроцентовПрикрепления.ЕстьОсновнойТовар

СГРУППИРОВАТЬ ПО
	ДоДобавленияПроцентовПрикрепления.ЗаказПокупателя,
	ДоДобавленияПроцентовПрикрепления.КоличествоТоваров,
	ДоДобавленияПроцентовПрикрепления.СуммаПрикрепления,
	ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления,
	ДоДобавленияПроцентовПрикрепления.Ответственный,
	ДоДобавленияПроцентовПрикрепления.Продавец,
	ДоДобавленияПроцентовПрикрепления.ВидОплаты,
	ДоДобавленияПроцентовПрикрепления.ИнформационныйСтатус,
	ДоДобавленияПроцентовПрикрепления.Статус,
	ДоДобавленияПроцентовПрикрепления.ИсточникЗаказа,
	ДоДобавленияПроцентовПрикрепления.КоличествоТоваровИсходныйЗаказ,
	ДоДобавленияПроцентовПрикрепления.СуммаПрикрепленияИсходныйЗаказ,
	ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ,
	ВЫБОР
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ < 0.12
			ТОГДА 1
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ <= 9.99
			ТОГДА 1.2
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ <= 14.99
			ТОГДА 1.5
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ <= 19.99
			ТОГДА 1.8
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияИсходныйЗаказ <= 49.99
			ТОГДА 2
		ИНАЧЕ 2.5
	КОНЕЦ,
	ВЫБОР
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления < 0.12
			ТОГДА 1
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления <= 9.99
			ТОГДА 1.2
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления <= 14.99
			ТОГДА 1.5
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления <= 19.99
			ТОГДА 1.8
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепления <= 49.99
			ТОГДА 2
		ИНАЧЕ 2.5
	КОНЕЦ,
	ДоДобавленияПроцентовПрикрепления.ЕстьОсновнойТовар,
	ВЫБОР
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ < 0.12
			ТОГДА 1
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ <= 9.99
			ТОГДА 1.2
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ <= 14.99
			ТОГДА 1.5
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ <= 19.99
			ТОГДА 1.8
		КОГДА ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ <= 49.99
			ТОГДА 2
		ИНАЧЕ 2.5
	КОНЕЦ,
	ДоДобавленияПроцентовПрикрепления.КоличествоТоваровОбработанныйЗаказ,
	ДоДобавленияПроцентовПрикрепления.СуммаПрикрепленияОбработанныйЗаказ,
	ДоДобавленияПроцентовПрикрепления.ПроцентПрикрепленияОбработанныйЗаказ
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ПочтиГотовыйЗапрос.ЗаказПокупателя КАК ЗаказПокупателя,
	ПочтиГотовыйЗапрос.КоличествоТоваров,
	ПочтиГотовыйЗапрос.СуммаПрикрепления,
	ПочтиГотовыйЗапрос.ПроцентПрикрепления,
	ПочтиГотовыйЗапрос.Ответственный КАК Ответственный,
	ПочтиГотовыйЗапрос.Продавец КАК Продавец,
	ПочтиГотовыйЗапрос.ВидОплаты КАК ВидОплаты,
	ПочтиГотовыйЗапрос.ИнформационныйСтатус КАК ИнформационныйСтатус,
	ПочтиГотовыйЗапрос.Статус КАК Статус,
	ПочтиГотовыйЗапрос.ИсточникЗаказа КАК ИсточникЗаказа,
	ПочтиГотовыйЗапрос.КоличествоТоваровИсходныйЗаказ,
	ПочтиГотовыйЗапрос.СуммаПрикрепленияИсходныйЗаказ,
	ПочтиГотовыйЗапрос.ПроцентПрикрепленияИсходныйЗаказ,
	ПочтиГотовыйЗапрос.КоэффициентИсходныйЗаказ,
	ПочтиГотовыйЗапрос.Коэффициент,
	ПочтиГотовыйЗапрос.ЕстьОсновнойТовар,
	ПочтиГотовыйЗапрос.КоличествоТоваровОбработанныйЗаказ,
	ПочтиГотовыйЗапрос.СуммаПрикрепленияОбработанныйЗаказ,
	ПочтиГотовыйЗапрос.ПроцентПрикрепленияОбработанныйЗаказ,
	ПочтиГотовыйЗапрос.КоэффициентОбработанныйЗаказ,
	ПочтиГотовыйЗапрос.ПроцентПрикрепленияКоличество,
	ПочтиГотовыйЗапрос.ПроцентПрикрепленияИсходныйЗаказКоличество,
	ПочтиГотовыйЗапрос.ПроцентПрикрепленияОбработанныйЗаказКоличество,
	ПочтиГотовыйЗапрос.КоличествоВыполненныхЗаказов,
	ПочтиГотовыйЗапрос.КоличествоКомплексныхЗаказов,
	ВЫРАЗИТЬ(ПочтиГотовыйЗапрос.КоличествоКомплексныхЗаказов * ПочтиГотовыйЗапрос.КоличествоВыполненныхЗаказов * 100 КАК ЧИСЛО(10, 2)) КАК ПроцентКомплексныхПродаж
ИЗ
	ПочтиГотовыйЗапрос КАК ПочтиГотовыйЗапрос
